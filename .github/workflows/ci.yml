name: CI Pipeline

on:
  pull_request:
    branches: [ main ]
  push:
    branches-ignore: [ main ]

jobs:
  ci-checks:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ==================================================
      # Python Setup
      # ==================================================
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt

      # ==================================================
      # Linting
      # ==================================================
      - name: Run flake8
        run: flake8 .

      # ==================================================
      # Django Unit Tests
      # ==================================================
      - name: Run Django tests
        working-directory: backend
        run: |
          python manage.py migrate --noinput
          python manage.py test --noinput

      # ==================================================
      # Docker Build (Backend)
      # ==================================================
      - name: Build backend Docker image
        run: docker build -t learnhub-backend backend/

      # ==================================================
      # Frontend build
      # ==================================================
      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      # ==================================================
      # Trivy Scan (Container)
      # ==================================================
      - name: Trivy Security Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: image
          image-ref: learnhub-backend
          severity: HIGH,CRITICAL
          exit-code: 1

      # ==================================================
      # tfsec Scan (Terraform IaC)
      # ==================================================
      - name: Run tfsec (Terraform scanning)
        run: |
          curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash
          tfsec terraform/
